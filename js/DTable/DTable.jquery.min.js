/*! DTable - v0.5.1 - 2014-03-19
* https://github.com/kubanka-peter/dtable
* Copyright (c) 2014 Kubi; Licensed MIT */

var DTableInterfaces=function(){var a=function(){var a=!1,b=/xyz/.test(function(){})?/\b_super\b/:/.*/,c=function(){};return c.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d},c}(),b={},c=a.extend({getIFaceNames:function(){var a=[];for(var c in b)a.push(c);return a},isExist:function(a){return void 0==b[a]?!1:!0},add:function(a,c){if(this.isExist(a))throw"Interface "+a+" is exists";b[a]=this.extend(c)},get:function(a){if(!this.isExist(a))throw"Interface "+a+" is not exists";return b[a]},extend:function(b){return a.extend(b)}});return new c}(jQuery),DTableModule=function(a,b){var c=!1,d=a.extend({init:function(){this.MODULE_TEMPLATE="template",this.MODULE_DEFINITION="definition",this.MODULE_LOGGER="logger",this.MODULE_SOURCE="source",this.MODULE_SEARCH="search",this.MODULE_PAGINATION="pagination",this.MODULE_LOADING="loading",this.MODULE_ORDER="order",this.MODULE_FORMATTER="formatter",this.MODULE_CORE="core",this.MODULE_FORMATTER_WIDGET="formatter_widget"},initModules:function(){0==c&&(c={},b.each(a.getIFaceNames(),function(a,b){c[b]={}}))},check:function(b){if(!a.isExist(b))throw"Invalid DTableModule type"},isExist:function(a,b){return this.initModules(),void 0==c[a]||void 0==c[a][b]?!1:!0},getModule:function(a,b,d,e){if(this.initModules(),this.check(a),!this.isExist(a,b))throw"DTableModule '"+b+"' doesn't exist.";return new c[a][b](d,e)},newModule:function(b,d,e){if(this.initModules(),this.check(b),this.isExist(b,d))throw"DTableModule "+d+" already exist.";c[b][d]=a.get(b).extend(e)},extendModule:function(a,b,d,e){if(this.initModules(),this.check(a),!this.isExist(a,b))throw"DTableModule '"+b+"' doesn't exist.";if(this.isExist(a,d))throw"DTableModule "+d+" already exist.";c[a][d]=c[a][b].extend(e)}});return new d}(DTableInterfaces,jQuery);!function(a){a.add("core",{init:function(a,b){this.table=b;var c={definition:{name:"json_url",options:{}},template:{name:"nunjucks",options:{}},logger:{name:"default",options:{}},source:{name:"json_url",options:{}},search:{name:"default",options:{}},pagination:{name:"default",options:{}},loading:{name:"default",options:{}},order:{name:"default",options:{}},formatter:{name:"advanced",options:{widget:"string"}}};this.options=$.extend(!0,{},c,a),this.configure()},update:function(){}})}(DTableInterfaces),function(a){a.add("definition",{isLoaded:!1,loading:function(){},getTitle:function(){},getColumns:function(){},getPagination:function(){},getSearch:function(){},hasColumnFilter:function(){},hasColumnTitle:function(){}})}(DTableInterfaces),function(a){a.add("formatter",{format:function(a,b){return b}})}(DTableInterfaces),function(a,b){a.add("formatter_widget",{init:function(a,c){this.dtable=c,this.options=b.extend(!0,{},this.getDefaults(),a)},getDefaults:function(){return{}},format:function(a,b){return b}})}(DTableInterfaces,jQuery),function(a){a.add("loading",{startLoading:function(){},stopLoading:function(){}})}(DTableInterfaces),function(a){a.add("logger",{error:function(){},info:function(){}})}(DTableInterfaces),function(a){a.add("order",{getOrderBy:function(){}})}(DTableInterfaces),function(a){a.add("pagination",{getPage:function(){},setPage:function(){},getShowFirstLast:function(){},getPageNum:function(){},getRowsPerPage:function(){},setRowsPerPage:function(){},getMaxPage:function(){},getPagesArr:function(){},getOffset:function(){},getRowsPerPageSelect:function(){}})}(DTableInterfaces),function(a){a.add("search",{update:function(){},getParams:function(){}})}(DTableInterfaces),function(a){a.add("source",{isLoaded:!1,loading:function(){},getRows:function(){},getCount:function(){}})}(DTableInterfaces),function(a){a.add("template",{isLoaded:!1,addTemplate:function(){},getTemplate:function(){},loading:function(){},getTableHtml:function(){},getRowsHtml:function(){},getPaginationHtml:function(){}})}(DTableInterfaces),function(a,b){a.newModule(a.MODULE_CORE,"firefly",{configure:function(){var b=this;this.definition=a.getModule(a.MODULE_DEFINITION,this.options.definition.name,this.options.definition.options,this),this.pagination=a.getModule(a.MODULE_PAGINATION,this.options.pagination.name,this.options.pagination.options,this),this.template=a.getModule(a.MODULE_TEMPLATE,this.options.template.name,this.options.template.options,this),this.logger=a.getModule(a.MODULE_LOGGER,this.options.logger.name,this.options.logger.options,this),this.source=a.getModule(a.MODULE_SOURCE,this.options.source.name,this.options.source.options,this),this.search=a.getModule(a.MODULE_SEARCH,this.options.search.name,this.options.search.name,this),this.loading=a.getModule(a.MODULE_LOADING,this.options.loading.name,this.options.loading.options,this),this.order=a.getModule(a.MODULE_ORDER,this.options.order.name,this.options.order.options,this),this.formatter=!1,this.loading.startLoading(),this.definition.loading(function(){b.formatter=a.getModule(a.MODULE_FORMATTER,b.options.formatter.name,b.options.formatter.options,b),b.template.loading(b.loaded)})},loaded:function(){this.definition.isLoaded&&this.template.isLoaded&&(this.renderTable(),this.update())},update:function(){this.loading.startLoading(),this.source.loading(this.sourceUpdated)},sourceUpdated:function(){this.loading.stopLoading(),this.renderRows(),this.renderPagination(),this.table.trigger("dtable.updated")},renderTable:function(){var a=this.template.getTableHtml({title:this.definition.getTitle(),pagination:this.definition.getPagination(),search:this.definition.getSearch(),columns:this.definition.getColumns(),has_column_filter:this.definition.hasColumnFilter(),has_column_title:this.definition.hasColumnTitle()});this.renderTableHtml(a)},renderTableHtml:function(a){this.table.html(a)},renderRows:function(){var a=this.source.getRows(),c=this.formatter;b.each(a,function(d,e){b.each(e,function(b,f){a[d][b]=c.format(b,f,e)})});var d=this.template.getRowsHtml({rows:a,columns:this.definition.getColumns()});this.renderRowsHtml(d)},renderRowsHtml:function(a){var b=this.table.find('[data-dtable="table"]');b.length?b.html(a):this.logger.error('Can\'t find rows root element [data-dtable="table"]')},renderPagination:function(){var a="",b=this.pagination.getPagesArr();b&&(a=this.template.getPaginationHtml({first:1,last:this.pagination.getMaxPage(),pages:b,active:this.pagination.getPage(),first_last:this.definition.getPagination().show_first_last,rows_per_page:this.pagination.getRowsPerPage(),rows_per_page_select:this.pagination.getRowsPerPageSelect()})),this.renderPaginationHtml(a)},renderPaginationHtml:function(a){var b=this.table.find('[data-dtable="pagination"]');b.length&&b.html(a)}})}(DTableModule,jQuery),function(a,b){a.newModule(a.MODULE_DEFINITION,"json_url",{init:function(a,c){this.definition={},this.isLoaded=!1;var d={method:"get",url:"",data:{},timestamp:!1};this.dtable=c,this.options=b.extend({},d,a)},getTitle:function(){return this.definition.title},getColumns:function(){return this.definition.columns},getPagination:function(){return{show_first_last:this.dtable.pagination.getShowFirstLast(),pages:this.dtable.pagination.getPageNum(),rows_per_page:this.dtable.pagination.getRowsPerPage()}},getSearch:function(){return{placeholder:this.dtable.search.options.placeholder}},hasColumnFilter:function(){return this.definition.has_column_filter},hasColumnTitle:function(){return this.definition.has_column_title},loading:function(a){function c(c){e.definition=c,e.isLoaded=!0,e.dtable.logger.info("json_url.definition: resource is loaded"),e.definition.has_column_filter=!1,e.definition.has_column_title=!1,b.each(e.getColumns(),function(a,b){b.filter&&(e.definition.has_column_filter=!0),b.title&&(e.definition.has_column_title=!0)}),a.call(e.dtable)}var d=this.options.url,e=this,f="POST";"get"==this.options.method&&(f="GET"),b.ajax(d,{url:d,type:f,async:!0,cache:this.options.timestamp,data:this.options.data,dataType:"json",error:function(){e.dtable.logger.error("Can't load definition resource from "+d)},success:c})}})}(DTableModule,jQuery),function(a,b){a.fn.dtable=function(a,c){var d;return this.data("dtable")?d=this.data("dtable"):(c=c||"firefly",d=b.getModule(b.MODULE_CORE,c,a,this)),d}}(jQuery,DTableModule),function(a,b){a.newModule(a.MODULE_FORMATTER,"advanced",{init:function(a,c){var d={widget:"string",widget_options:{escape:!0}};this.dtable=c,this.options=b.extend(!0,{},d,a),this.widgets=!1,this.buildWidgetSchema()},buildWidgetSchema:function(){if(0==this.widgets){this.widgets={};var a=this,c=this.dtable.definition.getColumns();b.each(c,function(c,d){var e=a.options;d.hasOwnProperty("formatter")&&d.formatter&&(e=b.extend(!0,{widget_options:{column_id:c}},a.options,d.formatter)),a.setWidget(c,e)})}},setWidget:function(b,c){this.widgets[b]=a.getModule(a.MODULE_FORMATTER_WIDGET,c.widget,c.widget_options,this.dtable)},getWidget:function(a){if(void 0==this.widgets[a])throw"widget does not exist for "+a;return this.widgets[a]},format:function(a,b,c){var d=this.getWidget(a);return d.format(a,b,c)}})}(DTableModule,jQuery),function(a,b){a.newModule(a.MODULE_FORMATTER,"simple",{init:function(a,c){var d={widget:"string",widget_options:{escape:!0}};this.options=b.extend(!0,{},d,a),this.dtable=c,this.widget=!1},initWidget:function(){0==this.widget&&(this.widget=a.getModule(a.MODULE_FORMATTER_WIDGET,this.options.widget,this.options.widget_options,this.dtable))},format:function(a,b,c){return this.initWidget(),this.widget.format(a,b,c)}})}(DTableModule,jQuery),function(a){a.newModule(a.MODULE_FORMATTER_WIDGET,"number",{getDefaults:function(){return{number_format:"0,0.0",language:"en",force_number:!1}},format:function(a,b){return(!isNaN(parseInt(b))||this.options.force_number)&&(numeral.language(this.options.language),b=numeral(b).format(this.options.number_format)),b}})}(DTableModule,jQuery),function(a){a.newModule(a.MODULE_FORMATTER_WIDGET,"partial",{init:function(a,b){if(this._super(a,b),void 0==this.options.template||0==this.options.template)throw"partial widget requires template option";this.templateName="partial_"+this.options.column_id,this.dtable.template.addTemplate(this.templateName,this.options.template),this.template=!1},getDefaults:function(){return{template:!1}},format:function(a,b,c){return this.template===!1&&(this.template=this.dtable.template.getTemplate(this.templateName)),this.template.render({value:b,column_id:a,values:c,xy:function(){return"a"}})}})}(DTableModule,jQuery),function(a){a.newModule(a.MODULE_FORMATTER_WIDGET,"string",{entityMap:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},escapeHTML:function(a){var b=this;return String(a).replace(/[&<>"'\/]/g,function(a){return b.entityMap[a]})},getDefaults:function(){return{escape:!0}},format:function(a,b){return this.options.escape?this.escapeHTML(b):b}})}(DTableModule,jQuery),function(a){a.newModule(a.MODULE_LOADING,"default",{init:function(a,b){this.dtable=b,this.div=!1,this.enabled=!1,this.is_loading=!1;var c=b.table.find('[data-dtable="loading"]');c.length&&(this.enabled=!0,this.div=c)},startLoading:function(){var a=this;this.dtable.table.trigger("dtable.start_loading"),!this.is_loading&&this.enabled&&(this.is_loading=!0,setTimeout(function(){a.is_loading&&a.dtable.table.find('[data-dtable="loading-container"]').html(a.div)},300))},stopLoading:function(){if(this.dtable.table.trigger("dtable.stop_loading"),this.enabled){this.is_loading=!1;var a=this.dtable.table.find('[data-dtable="loading"]');a.length&&a.remove()}}})}(DTableModule,jQuery),function(a){a.newModule(a.MODULE_LOGGER,"default",{init:function(a,b){var c={debug:!1};this.dtable=b,this.options=$.extend({},c,a)},error:function(a){throw this.dtable.loading.stopLoading(),this.dtable.table.html("Error."),a},info:function(a){this.options.debug&&console.log(a)}})}(DTableModule),function(a,b){a.newModule(a.MODULE_ORDER,"default",{init:function(a,c){var d={};this.options=b.extend({},d,a),this.dtable=c,this.columns="";var e=this;this.dtable.table.on("click",'[data-dtable="order.asc"]',function(){return e.setOrder(b(this),"asc"),!1}),this.dtable.table.on("click",'[data-dtable="order.desc"]',function(){return e.setOrder(b(this),"desc"),!1})},setOrder:function(a,b){this.dtable.table.find('[data-dtable="order.asc"]').removeClass("active"),this.dtable.table.find('[data-dtable="order.desc"]').removeClass("active"),a.addClass("active"),this.columns={},this.columns[a.attr("data-dtable-column")]=b,this.dtable.update()},getOrderBy:function(){return this.columns}})}(DTableModule,jQuery),function(a,b){a.newModule(a.MODULE_PAGINATION,"default",{init:function(a,c){var d={show_first_and_last:!0,pages:5,rows_per_page:20,rows_per_page_select:[20,50,100]};this.page=1,this.dtable=c,this.options=b.extend({},d,a);var e=this;c.table.on("click",'[data-dtable="page"]',function(){var a=b(this),c=a.attr("data-page");return e.setPage(c),e.dtable.update(),!1}),c.table.on("change",'[data-dtable="rows-per-page-select"]',function(){var a=b(this).val();return e.setRowsPerPage(a),e.dtable.update(),!1})},getPage:function(){return this.page},setPage:function(a){this.page=parseInt(a)},getShowFirstLast:function(){return this.options.show_first_and_last},getPageNum:function(){return this.options.pages},getRowsPerPage:function(){return this.options.rows_per_page},setRowsPerPage:function(a){this.options.rows_per_page=a},getMaxPage:function(){return Math.ceil(this.dtable.source.getCount()/this.dtable.definition.getPagination().rows_per_page)},getOffset:function(){return this.page*this.options.rows_per_page-this.options.rows_per_page},getPagesArr:function(){var a=this.getMaxPage(),b=1,c=Math.round((this.dtable.definition.getPagination().pages-1)/2),d=this.getPage()-c,e=this.getPage()+c;d=Math.max(b,d),e=Math.min(a,e),e<this.dtable.definition.getPagination().pages&&(e=Math.min(this.dtable.definition.getPagination().pages,a)),e-d<this.dtable.definition.getPagination().pages&&(d=e-this.dtable.definition.getPagination().pages+1,b>d&&(d=b));var f=!1;if(d!=e){f=[];for(var g=d;e>=g;g++)f.push(g)}return f},setRowsPerPageSelect:function(a){this.options.rows_per_page_select=a},getRowsPerPageSelect:function(){return this.options.rows_per_page_select}})}(DTableModule,jQuery),function(a,b){a.newModule(a.MODULE_SEARCH,"default",{init:function(a,c){var d={placeholder:"search ...",waiting:600};this.search="",this.filter="",this.in_progress=!1,this.update_after=!1,this.options=b.extend({},d,a),this.dtable=c;var e=this;this.dtable.table.on("keyup",'[data-dtable="search"]',function(){e.search=b(this).val(),e.dtable.pagination.setPage(1),e.update()}),this.dtable.table.on("keyup",'[data-dtable="filter"]',function(){var a=b(this);""===e.filter&&(e.filter={}),e.filter[a.attr("data-column")]=a.val(),e.dtable.pagination.setPage(1),e.update()})},update:function(){var a=parseInt(this.options.waiting);if(this.update_after=(new Date).getTime()+a,!this.in_progress){this.in_progress=!0;var b=this,c=function(){(new Date).getTime()>=b.update_after?(b.in_progress=!1,b.dtable.update()):setTimeout(c,a/2)};setTimeout(c,a/2)}},getParams:function(){var a={search:this.search,filter:this.filter,per_page:this.dtable.definition.getPagination().rows_per_page,offset:this.dtable.pagination.getOffset(),order:this.dtable.order.getOrderBy()};return a}})}(DTableModule,jQuery),function(a,b){a.newModule(a.MODULE_SOURCE,"json_url",{init:function(a,c){var d={url:"",method:"post"};this.data=null,this.isLoaded=!1,this.options=b.extend({},d,a),this.dtable=c},loading:function(a){function c(b){"count"in b&&"rows"in b||f.dtable.logger.error("Invalid source response"),f.data=b,f.isLoaded=!0,a.call(f.dtable)}function d(){f.dtable.logger.error("Can't load source resource from "+e)}var e=this.options.url,f=this;"get"==this.options.method?b.get(e,f.dtable.search.getParams(),c,"json").error(d):b.post(e,f.dtable.search.getParams(),c,"json").error(d)},getRows:function(){return this.data.rows},getCount:function(){return this.data.count}})}(DTableModule,jQuery),function(a,b){a.newModule(a.MODULE_TEMPLATE,"nunjucks",{init:function(a,c){this.isLoaded=!1;var d={view_dir:"/views",table_template:"table.html",rows_template:"rows.html",pagination_template:"pagination.html"};this.dtable=c,this.options=$.extend({},d,a),this.templates={},this.addTemplate("table",this.options.table_template),this.addTemplate("rows",this.options.rows_template),this.addTemplate("pagination",this.options.pagination_template),this.env=new b.Environment(new b.WebLoader(this.options.view_dir))},addTemplate:function(a,b){if(void 0!=this.templates[a])throw"template "+a+" is sexist";this.templates[a]={file:b,template:!1}},getTemplate:function(a){if(void 0==this.templates[a])throw"template "+a+" is'nt exist.";return this.templates[a].template},loading:function(a){var b=this,c=function(){var c=!0;$.each(b.templates,function(a,b){b.template||(c=!1)}),c&&(b.isLoaded=!0,b.dtable.logger.info("nunjucks.template.js: all loaded"),a.call(b.dtable))};$.each(this.templates,function(a,d){d.template||b.env.getTemplate(d.file,function(d,e){d?b.dtable.logger.error(d):(b.templates[a].template=e,b.dtable.logger.info("nunjucks.template.js: "+a+" is loaded"),c())})})},getTableHtml:function(a){return this.getTemplate("table").render(a)},getRowsHtml:function(a){return this.getTemplate("rows").render(a)},getPaginationHtml:function(a){return this.getTemplate("pagination").render(a)}})}(DTableModule,nunjucks);
//# sourceMappingURL=DTable.jquery.min.map